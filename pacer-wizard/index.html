<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>PACER Counsel Wizard</title>
    <meta name="description" content="Transform counsel information from U.S. District Courts into organized attorney information in the click of a button">
    <meta name="author" content="Your Name Here"> <meta name="keywords" content="PACER, ECF, counsel, attorney, legal, docket, wizard, parser"> <meta property="og:title" content="PACER Counsel Wizard">
    <meta property="og:description" content="Transform counsel information from U.S. District Courts into organized attorney information in the click of a button">
    <meta property="og:image" content="https://raw.githubusercontent.com/owens4414/Pacer_Parties/main/images/EF_Add.png"> <meta property="og:url" content="https://your-website-url.com"> <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=1">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=1">
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=1"> <link rel="manifest" href="/site.webmanifest?v=1">            <link rel="mask-icon" href="/safari-pinned-tab.svg?v=1" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            margin: 0;
        }
        
        .page-wrapper {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
        }
        
        .home-link {
            display: inline-block;
            margin-bottom: 15px;
            color: #5a6472;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .home-link:hover {
            color: #1e3c72;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            margin-top: 1em; /* <-- Add this line */
        }

        .content {
            padding: 40px;
        }

        .mode-switcher {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            font-weight: 600;
            color: #2c3e50;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .instructions {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border-left: 5px solid #2196f3;
            position: relative;
            overflow: hidden;
        }

        .instructions::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .instructions h3 {
            color: #1565c0;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #424242;
        }

        .instructions li {
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .instructions .note {
            background: rgba(255, 193, 7, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-section label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-family: 'JetBrains Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            resize: vertical;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        textarea:focus {
            border-color: #2196f3;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 160px;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: linear-gradient(135deg, #bdbdbd 0%, #9e9e9e 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(189, 189, 189, 0.3);
        }

        button.secondary {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #555;
            box-shadow: 0 4px 15px rgba(195, 207, 226, 0.4);
        }

        button.secondary:hover {
            box-shadow: 0 8px 25px rgba(195, 207, 226, 0.6);
        }

        button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        button.danger:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .results {
            margin-top: 40px;
        }

        .results h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .attorney-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 25px;
            margin: 15px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .attorney-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .attorney-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .attorney-name {
            font-weight: 700;
            color: #1a202c;
            font-size: 1.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .party-name {
            color: #718096;
            font-style: italic;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .party-status-terminated {
            font-weight: bold;
            color: #721c24; 
            margin-left: 8px;
        }

        .contact-info {
            margin-top: 15px;
            line-height: 1.8;
            color: #4a5568;
        }

        .contact-info strong {
            color: #2d3748;
            min-width: 120px;
            display: inline-block;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .active {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .terminated {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .unrepresented {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats-bar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            max-width: 18px;
            max-height: 18px;
            border-radius: 50%;
            background-color: #1565c0;
            color: white;
            font-weight: bold;
            font-size: 12px;
            margin-left: 8px;
            cursor: pointer;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .tooltip-content {
            display: none; 
        }

        .tooltip-content strong {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #667eea;
        }
        
        .tooltip-content p {
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .tooltip-content ul {
            list-style-type: disc;
            padding-left: 20px;
            margin: 0;
            column-count: 2;
        }

        .tooltip-content li {
            margin-bottom: 2px;
            padding-left: 0;
            font-size: 0.85em;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10vh auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        
        #modal-body {
            text-align: left;
        }

        .modal-close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: black;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .content { padding: 20px 15px; }
            textarea { height: 200px; }
            .button-group { flex-direction: column; }
            .stats-bar { flex-wrap: wrap; }
            .stat-item { flex: 1 1 45%; }
        }
        
        @media (max-width: 480px) {
            .stat-item { flex: 1 1 100%; }
            .modal-content { width: 95%; margin: 5vh auto; }
            .tooltip-content ul { column-count: 1; }
        }
    </style>
    <script data-goatcounter="https://owens4414.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</head>
<body>
    <div class="page-wrapper">
        <a href="../" class="home-link">← Back to Home</a>
        <div class="container">
            <div class="header">
                <h1>PACER Counsel Wizard</h1>
                <p>This free webapp allows you to copy and paste counsel data from U.S. District Courts and get organized attorney/party information in a formatted Excel file in return.  This app thus allows you to easily create service lists/emails lists and perform other case management tasks with ease.  No more extracting attorney information from the docket one-by-one.</p> 
                <p> </p>
                <p> Choose DOCKET MODE if you are taking the information from the docket itself and EMAIL MODE if you are creating a service list from an ECF notice email (the latter will only include email addresses as that is what is included on ECF notices and may include additional email addresses not on the docket insofar as the ECF notice includes supplemental email addresses e.g., email addresses for paralegals associated with a case).</p>
            </div>
            
            <div class="content">
                <div class="mode-switcher">
                    <span>Docket Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="modeToggle" onchange="toggleMode()">
                        <span class="slider round"></span>
                    </label>
                    <span>Email Notice Mode</span>
                </div>

                <div class="instructions" id="instructionsDocket">
                    <h3>📋 Instructions for Docket Mode</h3>
                    <ol>
                        <li>Copy the attorney info listed on a PACER docket from the first Plaintiff through the contact info for the last defense attorney (or some subset).
                            <span class="tooltip-container">
                                <button class="tooltip-trigger" onclick="showHelpModal()">?</button>
                                <div id="tooltipSource" class="tooltip-content">
                                    <strong>Supported Party Types</strong>
                                    <p>This script is designed to capture counsel information from U.S. District Court dockets for the following party types:</p>
                                    <ul>
                                        <li>Plaintiff</li> <li>Defendant</li> <li>Additional Defendant</li>
                                        <li>Amicus</li> <li>Applicant</li> <li>Appellant</li>
                                        <li>Appellee</li> <li>Counter Claimant</li> <li>Counterclaimant</li>
                                        <li>Counter Defendant</li> <li>Counterclaim Defendant</li> <li>Garnishee</li>
                                        <li>In Re</li> <li>Interested Party</li> <li>Intervenor</li>
                                        <li>Material Witness</li> <li>Mediator</li> <li>Movant</li>
                                        <li>Nominal Defendant</li> <li>Objector</li> <li>Petitioner</li>
                                        <li>Respondent</li> <li>Special Master</li> <li>Third Party Defendant</li>
                                        <li>Thirdparty Defendant</li> <li>Third Party Plaintiff</li> <li>Thirdparty Plaintiff</li>
                                    </ul>
                                </div>
                            </span>
                        </li>
                        <li>Paste it into the text area below (make sure it's all there -- copying text from PACER can be finicky).</li>
                        <li>Click "Parse Counsel Data" to extract attorney information.</li>
                        <li>Review the parsed data, then click "Generate Excel File" to download the contact info. The Excel file will be a filterable table which makes it easy to create email service lists, etc.  When pasting email addressess from Excel to Outlook, you may need to press tab after pasting for Outlook to recognize the email addresses.</li>
                    </ol>
                    <div class="note">
                        <strong>📝 Note:</strong> The Excel file will include all parties (represented and unrepresented) except for terminated attorneys (e.g., those who have withdrawn their appearance). Terminated *parties* will be included and noted so long as the attorney is not designated terminated.
                    </div>
                </div>

                <div class="instructions" id="instructionsEmail" style="display:none;">
                    <h3>📧 Instructions for Email Notice Mode</h3>
                    <ol>
                        <li>Copy the list of attorneys and their email addresses from a District Court's ECF email notice. Terminated attorneys name will be excluded automatically from the output.</li>
                        <li>Paste the list into the text area below. The expected format for each line is: <code>Attorney Name      email1@domain.com, email2@domain.com</code></li>
                        <li>Click "Parse Counsel Data" to extract the names and emails.</li>
                        <li>Review the parsed data, then click "Generate Excel File" to download. The Excel file will have the attorney name in the first column and a comma-separated list of all their emails in the second column.</li>
                    </ol>
                </div>

                <div class="input-section">
                    <label for="docketText">📄 Paste Text Here:</label>
                    <textarea id="docketText" placeholder="Paste your ECF docket information here..."></textarea>
                </div>

                <div class="button-group">
                    <button onclick="parseCounselData()">
                        🔍 Parse Counsel Data
                    </button>
                    <button id="excelBtn" onclick="generateExcel()" disabled>
                        📊 Generate Excel File
                    </button>
                    <button class="secondary" onclick="clearData()">
                        🗑️ Clear All
                    </button>
                </div>

                <div id="results" class="results"></div>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 20px 0; font-size: 12px; color: #6c757d;">
        <p>© Litigator Bot 2025. All Rights Reserved. This offering is made without any warranty, express or implied.</p>
        <p><a href="#" onclick="showLicenseModal(); return false;" style="color: #6c757d; text-decoration: none;">License Info</a></p>
    </footer>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="hideHelpModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let parsedAttorneys = [];
        let attorneyDirectory = {};
        let parsedEmails = [];
        let currentMode = 'docket';

        const modal = document.getElementById('helpModal');

        // --- Modal and UI Functions ---
        function showHelpModal() {
            const content = document.getElementById('tooltipSource').innerHTML;
            document.getElementById('modal-body').innerHTML = content;
            modal.style.display = 'block';
        }

        function showLicenseModal() {
            const licenseContent = `
                <h3 style="color: #2c3e50; margin-bottom: 20px;">License Info</h3>
                <p>This application uses the following third-party library:</p>
                <pre style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-top: 15px; text-align: left; overflow-x: auto;">
SheetJS Community Edition -- https://sheetjs.com/

Copyright (C) 2012-present   SheetJS LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</pre>
            `;
            document.getElementById('modal-body').innerHTML = licenseContent;
            modal.style.display = 'block';
        }

        function hideHelpModal() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                hideHelpModal();
            }
        }

        function toggleMode() {
            const toggle = document.getElementById('modeToggle');
            const docketInstructions = document.getElementById('instructionsDocket');
            const emailInstructions = document.getElementById('instructionsEmail');
            const docketTextarea = document.getElementById('docketText');

            if (toggle.checked) {
                currentMode = 'email';
                docketInstructions.style.display = 'none';
                emailInstructions.style.display = 'block';
                docketTextarea.placeholder = 'Paste your attorney email list here...\ne.g., John Smith    jsmith@law.com, jsmith2@law.com';
            } else {
                currentMode = 'docket';
                docketInstructions.style.display = 'block';
                emailInstructions.style.display = 'none';
                docketTextarea.placeholder = 'Paste your ECF docket information here...';
            }
            clearData();
        }

        // --- Core Logic ---
        function parseCounselData() {
            const docketText = document.getElementById('docketText').value;
            if (!docketText.trim()) {
                alert('Please paste some text first.');
                return;
            }

            // Clear previous results before parsing
            parsedAttorneys = [];
            attorneyDirectory = {};
            parsedEmails = [];

            try {
                if (currentMode === 'docket') {
                    parseDocketMode(docketText);
                } else {
                    parseEmailMode(docketText);
                }

                displayResults();
                const hasResults = (currentMode === 'docket' && parsedAttorneys.length > 0) || (currentMode === 'email' && parsedEmails.length > 0);
                document.getElementById('excelBtn').disabled = !hasResults;
            } catch (error) {
                document.getElementById('results').innerHTML = `<div style="color: #e74c3c; padding: 20px; background: #fdf2f2; border-radius: 12px; border: 1px solid #ffc1cc;">⚠️ Error parsing text: ${error.message}</div>`;
                console.error("Parsing error:", error);
            }
        }

        function displayResults() {
            if (currentMode === 'docket') {
                displayDocketResults();
            } else {
                displayEmailResults();
            }
        }

        function generateExcel() {
            if (currentMode === 'docket') {
                generateDocketExcel();
            } else {
                generateEmailExcel();
            }
        }

        function clearData() {
            document.getElementById('docketText').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('excelBtn').disabled = true;
            parsedAttorneys = [];
            attorneyDirectory = {};
            parsedEmails = [];
        }

        // --- Docket Mode Specific Functions ---
        function parseDocketMode(docketText) {
            const normalizedText = docketText.replace(/\u00a0/g, ' ');
            const lines = normalizedText.split('\n').map(line => line.trim()).filter(line => line);
            const partyTypes = [
                'Plaintiff', 'Defendant', 'Additional Defendant', 'Respondent', 'Movant',
                'Petitioner', 'Applicant', 'Intervenor', 'Appellant', 'Appellee', 'Special Master',
                'Third Party Defendant', 'Mediator', 'Amicus', 'Material Witness', 'Counterclaimant',
                'Counter Claimant', 'Counterclaim Defendant', 'Counter Defendant', 'Interested Party',
                'Nominal Defendant', 'Objector', 'Thirdparty Defendant', 'Third Party Plaintiff', 'Thirdparty Plaintiff',
                'In Re', 'Garnishee'
            ];
            const partyTypeRegex = new RegExp(`^(${partyTypes.join('|')})(.*)`, 'i');
            let currentPartyType = '', currentPartyName = '', currentPartyStatus = 'Active';
            let currentAttorney = '', attorneyInfo = [], collectingInfo = false, isUnrepresented = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line === 'V.') continue;

                const partyTypeMatch = line.match(partyTypeRegex);
                if (partyTypeMatch) {
                    if (currentPartyName) {
                        if (isUnrepresented) {
                            parsedAttorneys.push({ partyType: currentPartyType, partyName: currentPartyName, partyStatus: currentPartyStatus, name: '', firmAddress: '', phone: '', fax: '', email: '', terminated: false, unrepresented: true });
                        } else if (currentAttorney && collectingInfo) {
                            const attorney = buildAttorneyRecord(currentAttorney, attorneyInfo, currentPartyType, currentPartyName, currentPartyStatus);
                            if (attorney) parsedAttorneys.push(attorney);
                        }
                    }
                    currentPartyType = partyTypeMatch[1];
                    let partyNameBuilder = partyTypeMatch[2].trim();
                    let nextLineIndex = i + 1;
                    while (nextLineIndex < lines.length && !lines[nextLineIndex].includes('represented by') && !lines[nextLineIndex].match(partyTypeRegex)) {
                        if (lines[nextLineIndex] === 'V.') break;
                        partyNameBuilder += ` ${lines[nextLineIndex]}`;
                        i = nextLineIndex++;
                    }
                    let attorneyNameOnNextLine = '';
                    if (i + 1 < lines.length && lines[i + 1].includes('represented by')) {
                        const parts = lines[i + 1].split('represented by');
                        if (parts[0].trim()) partyNameBuilder += ` ${parts[0].trim()}`;
                        attorneyNameOnNextLine = parts[1].trim();
                    }
                    const terminationPattern = /\s*TERMINATED:?.*$/i;
                    const match = partyNameBuilder.match(terminationPattern);
                    currentPartyStatus = match ? 'Terminated' : 'Active';
                    currentPartyName = partyNameBuilder.replace(terminationPattern, '').trim();
                    if (attorneyNameOnNextLine) {
                        currentAttorney = attorneyNameOnNextLine;
                        isUnrepresented = false;
                        attorneyInfo = [];
                        collectingInfo = true;
                        i++;
                    } else {
                        currentAttorney = '';
                        attorneyInfo = [];
                        collectingInfo = false;
                        isUnrepresented = true;
                    }
                } else if (line.includes('represented by') && currentPartyName) {
                    isUnrepresented = false;
                    if (currentAttorney && collectingInfo) {
                        const attorney = buildAttorneyRecord(currentAttorney, attorneyInfo, currentPartyType, currentPartyName, currentPartyStatus);
                        if (attorney) parsedAttorneys.push(attorney);
                    }
                    currentAttorney = line.split('represented by')[1].trim();
                    attorneyInfo = [];
                    collectingInfo = true;
                } else if (collectingInfo) {
                    if (isAttorneyName(line)) {
                        const lastInfoLine = attorneyInfo.length > 0 ? attorneyInfo[attorneyInfo.length - 1] : '';
                        if (lastInfoLine.includes('ATTORNEY TO BE NOTICED') || lastInfoLine.includes('LEAD ATTORNEY') || lastInfoLine.includes('PRO HAC VICE') || lastInfoLine.includes('TERMINATED')) {
                            if (currentAttorney) {
                                const attorney = buildAttorneyRecord(currentAttorney, attorneyInfo, currentPartyType, currentPartyName, currentPartyStatus);
                                if (attorney) parsedAttorneys.push(attorney);
                            }
                            currentAttorney = line;
                            attorneyInfo = [];
                        } else {
                            attorneyInfo.push(line);
                        }
                    } else {
                        attorneyInfo.push(line);
                    }
                }
            }
            if (currentPartyName) {
                if (isUnrepresented) {
                    parsedAttorneys.push({ partyType: currentPartyType, partyName: currentPartyName, partyStatus: currentPartyStatus, name: '', firmAddress: '', phone: '', fax: '', email: '', terminated: false, unrepresented: true });
                } else if (currentAttorney && collectingInfo) {
                    const attorney = buildAttorneyRecord(currentAttorney, attorneyInfo, currentPartyType, currentPartyName, currentPartyStatus);
                    if (attorney) parsedAttorneys.push(attorney);
                }
            }
        }
        
        function isAttorneyName(line) {
            if (!line || line.trim() === '') return false;
            const normalizedLine = line.replace(/\s*,\s*/g, ', ').trim();
            if (normalizedLine.includes('@') || normalizedLine.includes('Fax:') || normalizedLine.includes('Email:') || normalizedLine.includes('ATTORNEY') || normalizedLine.includes('PRO HAC') || normalizedLine.includes('LEAD') || normalizedLine.includes('TERMINATED') || normalizedLine.includes('(See above') || normalizedLine.includes('LLP') || normalizedLine.includes('LLC') || normalizedLine.includes('STREET') || normalizedLine.includes('STE') || normalizedLine.includes('AVE') || normalizedLine.match(/^\d/) || normalizedLine.includes('SUITE') || normalizedLine.includes('FLOOR') || normalizedLine.includes('FLR')) { return false; }
            if (normalizedLine.includes('United Sta') || normalizedLine.includes('United States') || normalizedLine.match(/^[A-Z]{2}\s+\d/) || normalizedLine.includes('DRIVE') || normalizedLine.includes('ROAD') || normalizedLine.includes('BLVD') || normalizedLine.includes('PKWY') || normalizedLine.includes('PLAZA')) { return false; }
            if (!/^[A-Za-z\s\.\,\-]+(?:\s*,?\s*(?:I{1,3}|IV|V|Jr\.?|Sr\.?|Esq\.?))?$/.test(normalizedLine)) return false;
            if (normalizedLine.length > 60) return false;
            const words = normalizedLine.split(/\s+/);
            if (words.length < 2) { if (!normalizedLine.match(/(?:I{1,3}|IV|V|Jr\.?|Sr\.?)$/)) { return false; } }
            if (normalizedLine === normalizedLine.toUpperCase() && words.length > 4) return false;
            return true;
        }

        function buildAttorneyRecord(name, infoLines, partyType, partyName, partyStatus) {
            let firmAddress = '', phone = '', fax = '', email = '', terminated = false, firmAddressParts = [];
            if (infoLines.some(line => line.includes('(See above'))) {
                firmAddress = '(See above for address)';
            } else {
                for (const line of infoLines) {
                    if (line.includes('TERMINATED')) terminated = true;
                    else if (line.includes('@')) {
                        const emailMatch = line.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                        if (emailMatch) email = emailMatch[1];
                    } else if (line.includes('Fax:')) fax = line.replace('Fax:', '').trim();
                    else if (line.match(/^\d{3}[\-/]\d{3}[\-/]\d{4}/)) phone = line.trim();
                    else if (line.trim() && !line.includes('ATTORNEY TO BE NOTICED') && !line.includes('LEAD ATTORNEY') && !line.includes('PRO HAC VICE')) {
                        firmAddressParts.push(line.trim());
                    }
                }
                if (firmAddressParts.length > 0) firmAddress = firmAddressParts.join(', ');
            }
            if (infoLines.some(line => line.includes('TERMINATED'))) terminated = true;
            const record = { partyType, partyName, partyStatus, name: name.trim(), firmAddress: firmAddress || '', phone: phone || '', fax: fax || '', email: email || '', terminated, unrepresented: false };
            if (record.firmAddress && record.firmAddress !== '(See above for address)') {
                attorneyDirectory[record.name.toLowerCase()] = { firmAddress: record.firmAddress, phone: record.phone, fax: record.fax, email: record.email };
            }
            return record;
        }

        function displayDocketResults() {
            const resultsDiv = document.getElementById('results');
            if (parsedAttorneys.length === 0) { resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">🔭 No attorneys found in the pasted text.</div>'; return; }
            const activeCount = parsedAttorneys.filter(a => !a.terminated && !a.unrepresented).length;
            const terminatedCount = parsedAttorneys.filter(a => a.terminated).length;
            const unrepresentedCount = parsedAttorneys.filter(a => a.unrepresented).length;
            let html = `<h3>📊 Parsed Results</h3><div class="stats-bar"><div class="stat-item"><div class="stat-number">${parsedAttorneys.length}</div><div class="stat-label">Total Entries</div></div><div class="stat-item"><div class="stat-number">${activeCount}</div><div class="stat-label">Active EOAs</div></div><div class="stat-item"><div class="stat-number">${unrepresentedCount}</div><div class="stat-label">Unrepresented</div></div><div class="stat-item"><div class="stat-number">${terminatedCount}</div><div class="stat-label">Terminated EOAs</div></div></div>`;
            parsedAttorneys.forEach((attorney) => {
                const isUnrepresented = attorney.unrepresented || (!attorney.name || attorney.name.trim() === '');
                const isPartyTerminated = attorney.partyStatus === 'Terminated';
                html += `<div class="attorney-card"><div class="attorney-name">${attorney.name || '[Unrepresented Party]'}</div><div class="party-name">${attorney.partyType} ${attorney.partyName}${isPartyTerminated ? '<span class="party-status-terminated">(Terminated Party)</span>' : ''}</div><div class="contact-info">${!isUnrepresented ? `<div><strong>Firm/Address:</strong> ${attorney.firmAddress || 'N/A'}</div><div><strong>Phone:</strong> ${attorney.phone || 'N/A'}</div><div><strong>Fax:</strong> ${attorney.fax || 'N/A'}</div><div><strong>Email:</strong> ${attorney.email || 'N/A'}</div>` : '<em>No attorney of record</em>'}</div>${isUnrepresented ? '<span class="status unrepresented">UNREPRESENTED</span>' : `<span class="status ${attorney.terminated ? 'terminated' : 'active'}">${attorney.terminated ? 'ATTORNEY TERMINATED' : 'ATTORNEY ACTIVE'}</span>`}</div>`;
            });
            resultsDiv.innerHTML = html;
        }

        function generateDocketExcel() {
            const addedAttorneys = new Set();
            const toExport = [];
            parsedAttorneys.forEach(attorney => {
                if (attorney.terminated) return;
                const attorneyNameLower = attorney.name.toLowerCase();
                const isFirstEntry = !addedAttorneys.has(attorneyNameLower);
                const attorneyForExcel = { ...attorney };
                if (isFirstEntry) {
                    if (attorneyForExcel.firmAddress === '(See above for address)') {
                        const fullInfo = attorneyDirectory[attorneyNameLower];
                        if (fullInfo) { Object.assign(attorneyForExcel, fullInfo); }
                    }
                    if(attorney.name) addedAttorneys.add(attorneyNameLower);
                } else {
                    Object.assign(attorneyForExcel, { firmAddress: '(See above for address)', phone: '', fax: '', email: '' });
                }
                toExport.push(attorneyForExcel);
            });

            if (toExport.length === 0) { alert('No active EOAs or unrepresented parties to export.'); return; }
            const wb = XLSX.utils.book_new();
            const wsData = [['Party Type', 'Party Name', 'Party Status', 'Attorney Name', 'Firm/Address', 'Phone', 'Fax', 'Email', 'Attorney Status']];
            toExport.forEach(attorney => { wsData.push([attorney.partyType, attorney.partyName, attorney.partyStatus, attorney.name || '[Unrepresented]', attorney.firmAddress || '', attorney.phone || '', attorney.fax || '', attorney.email || '', attorney.unrepresented ? 'Unrepresented' : 'Active']); });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const colWidths = wsData[0].map((_, i) => ({ width: wsData.reduce((w, r) => Math.max(w, String(r[i]).length), 10) + 2 }));
            ws['!cols'] = colWidths.map(w => ({width: Math.min(w.width, 50)}));
            ws['!autofilter'] = { ref: XLSX.utils.encode_range(XLSX.utils.decode_range(ws['!ref'])) };
            XLSX.utils.book_append_sheet(wb, ws, "Counsel List");
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `ECF_Counsel_${dateStr}.xlsx`);
        }

        // --- Email Notice Mode Specific Functions ---
        function parseEmailMode(docketText) {
            const normalizedText = docketText.replace(/\u00a0/g, ' ');
            const lines = normalizedText.split('\n').filter(line => line.trim() !== '');

            parsedEmails = lines.map(line => {
                const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
                const match = line.match(emailRegex);
                if (!match) return null;

                const firstEmailIndex = match.index;
                const name = line.substring(0, firstEmailIndex).trim();
                const emailString = line.substring(firstEmailIndex).trim();
                const emails = emailString.split(/[\s,]+/).filter(email => email.trim() !== '' && email.includes('@'));

                return { name, emails };
            })
            .filter(item => item !== null && item.emails.length > 0)
            .filter(item => !item.name.toLowerCase().includes('(terminated)'));
        }

        function displayEmailResults() {
            const resultsDiv = document.getElementById('results');
            if (parsedEmails.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">🔭 No valid attorney/email entries found.</div>';
                return;
            }

            let html = `<h3>📧 Parsed Email List</h3><div class="stats-bar"><div class="stat-item"><div class="stat-number">${parsedEmails.length}</div><div class="stat-label">Total Attorneys</div></div></div>`;
            parsedEmails.forEach(entry => {
                html += `<div class="attorney-card"><div class="attorney-name">${entry.name || '[No Name Found]'}</div><div class="contact-info"><strong>Emails:</strong> ${entry.emails.join(', ')}</div></div>`;
            });
            resultsDiv.innerHTML = html;
        }

        function generateEmailExcel() {
            if (parsedEmails.length === 0) {
                alert('No data to export.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const header = ['Attorney Name', 'Emails'];
            const wsData = [header];

            parsedEmails.forEach(entry => {
                const emailString = entry.emails.join(', ');
                wsData.push([entry.name, emailString]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const colWidths = wsData[0].map((_, i) => ({ 
                width: wsData.reduce((w, r) => Math.max(w, String(r[i] || '').length), 10) + 2 
            }));
            ws['!cols'] = colWidths.map(w => ({width: Math.min(w.width, 80)}));

            XLSX.utils.book_append_sheet(wb, ws, "Email List");
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Attorney_Emails_${dateStr}.xlsx`);
        }
    </script>
</body>
</html>
